name: Monthly Release Tag
on:
  schedule:
    - cron: '10 1 1-3 * *'
  workflow_dispatch:

jobs:
  tag:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: npm i -g pnpm && pnpm i
      - run: pnpm guard
      - run: pnpm fingerprint
      - run: node scripts/should-build.mjs || true
      - run: pnpm labs || true
      - name: Compute signal and tag
        run: |
          node -e "
            const fs=require('fs');
            const labs=fs.existsSync('reports/labs.json')?JSON.parse(fs.readFileSync('reports/labs.json','utf8')):{pass:0,fail:0};
            const flags=fs.existsSync('reports/yellow-flags.json')?JSON.parse(fs.readFileSync('reports/yellow-flags.json','utf8')):[];
            const pagesTouched=Number(process.env.PAGES_TOUCHED||1);
            const total=(labs.pass+labs.fail)||1;
            const passRate=labs.pass/total;
            const openFlags=flags.length;
            const signal=Math.round(40*pagesTouched + 40*passRate*10 - 20*Math.min(openFlags,10));
            console.log({pagesTouched, passRate, openFlags, signal});
            const now=new Date(); const tag=`site-v${now.getUTCFullYear()}.${String(now.getUTCMonth()+1).padStart(2,'0')}`;
            const {execSync}=require('child_process');
            try{execSync('git rev-parse --verify '+tag,{stdio:'ignore'}); process.exit(0);}catch{}
            execSync('git tag '+tag); execSync('git push origin '+tag);
          "
      - uses: actions/upload-artifact@v4
        with:
          name: reports
          path: reports
