name: PR Checklist Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths: ['docs/**']

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  autocheck:
    name: Automated PR Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Need full history to check last commit dates

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run automated checks
        id: checks
        run: |
          echo "## ðŸ“Š Comprehensive PR Summary" > report.md
          echo "" >> report.md
          echo "_Automated analysis of all workflow checks and quality gates_" >> report.md
          echo "" >> report.md

          # Initialize status tracking
          RED_COUNT=0
          YELLOW_COUNT=0
          GREEN_COUNT=0

          # Frontmatter validation
          echo "### ðŸ“‹ Frontmatter Validation" >> report.md
          pnpm run guard > guard-output.txt 2>&1 || true
          if grep -q "Missing required frontmatter" guard-output.txt; then
            echo "âŒ **FAILED** - Missing required frontmatter fields" >> report.md
            grep "Missing required frontmatter" guard-output.txt | sed 's/^/  - /' >> report.md
            RED_COUNT=$((RED_COUNT + 1))
          else
            echo "âœ… **PASSED** - All files have required frontmatter" >> report.md
            GREEN_COUNT=$((GREEN_COUNT + 1))
          fi
          echo "" >> report.md

          # Change size calculation
          echo "### ðŸ“ Change Size Analysis" >> report.md
          FILES_CHANGED=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep '\.md$' | grep '^docs/' || echo "")
          if [ -z "$FILES_CHANGED" ]; then
            echo "â„¹ï¸ No markdown files changed in docs/" >> report.md
          else
            echo "$FILES_CHANGED" | while read file; do
              if [ -f "$file" ]; then
                LINES_CHANGED=$(git diff origin/${{ github.base_ref }}...HEAD -- "$file" | grep -E '^\+|^-' | grep -v '^\+\+\+\|^---' | wc -l)

                # Extract declared change_type from frontmatter
                CHANGE_TYPE=$(grep -m1 'change_type:' "$file" | sed 's/change_type: *//' | tr -d ' ')

                # Determine expected change_type based on lines
                if [ "$LINES_CHANGED" -le 200 ]; then
                  EXPECTED="patch"
                elif [ "$LINES_CHANGED" -le 400 ]; then
                  EXPECTED="minor"
                else
                  EXPECTED="major"
                fi

                if [ "$CHANGE_TYPE" = "$EXPECTED" ]; then
                  echo "  - âœ… \`$file\`: ${LINES_CHANGED} lines changed, declared as \`${CHANGE_TYPE}\` (correct)" >> report.md
                else
                  echo "  - âš ï¸ \`$file\`: ${LINES_CHANGED} lines changed, declared as \`${CHANGE_TYPE}\` but should be \`${EXPECTED}\`" >> report.md
                fi
              fi
            done
          fi
          echo "" >> report.md

          # Content guard results
          echo "### ðŸ›¡ï¸ Content Guard (Band A Compliance)" >> report.md
          if grep -q "RED FAILURES" guard-output.txt; then
            echo "âŒ **BLOCKED** - Red failures detected:" >> report.md
            grep -A 10 "RED FAILURES" guard-output.txt | tail -n +2 | grep -E '^\s+-' | sed 's/^/  /' >> report.md
            RED_COUNT=$((RED_COUNT + 1))
          elif grep -q "YELLOW WARNINGS" guard-output.txt; then
            echo "âš ï¸ **REVIEW NEEDED** - Yellow warnings detected:" >> report.md
            grep -A 10 "YELLOW WARNINGS" guard-output.txt | tail -n +2 | grep -E '^\s+-' | sed 's/^/  /' >> report.md
            YELLOW_COUNT=$((YELLOW_COUNT + 1))
          else
            echo "âœ… **PASSED** - No guard violations" >> report.md
            GREEN_COUNT=$((GREEN_COUNT + 1))
          fi
          echo "" >> report.md

          # Link validation
          echo "### ðŸ”— Link Validation" >> report.md
          pnpm run links > links-output.txt 2>&1 || true
          if grep -q "Broken Internal Links" links-output.txt; then
            echo "âŒ **FAILED** - Broken internal links detected" >> report.md
            grep -A 20 "Broken Internal Links" links-output.txt | tail -n +2 | sed 's/^/  /' >> report.md
            RED_COUNT=$((RED_COUNT + 1))
          else
            echo "âœ… **PASSED** - All internal links valid" >> report.md
            GREEN_COUNT=$((GREEN_COUNT + 1))
          fi

          if grep -q "External Link Issues" links-output.txt; then
            echo "âš ï¸ **WARNING** - External link issues detected" >> report.md
            grep -A 20 "External Link Issues" links-output.txt | tail -n +2 | sed 's/^/  /' >> report.md
            YELLOW_COUNT=$((YELLOW_COUNT + 1))
          fi
          echo "" >> report.md

          # Build test
          echo "### ðŸ—ï¸ Build Test" >> report.md
          if pnpm run docs:build > build-output.txt 2>&1; then
            echo "âœ… **PASSED** - Documentation builds successfully" >> report.md
            GREEN_COUNT=$((GREEN_COUNT + 1))
          else
            echo "âŒ **FAILED** - Build errors detected" >> report.md
            tail -20 build-output.txt | sed 's/^/  /' >> report.md
            RED_COUNT=$((RED_COUNT + 1))
          fi
          echo "" >> report.md

          # Component tests
          echo "### ðŸ§ª Component Tests" >> report.md
          if pnpm test > test-output.txt 2>&1; then
            TEST_RESULTS=$(grep -E "Test Files|Tests" test-output.txt | head -1 || echo "Tests passed")
            echo "âœ… **PASSED** - $TEST_RESULTS" >> report.md
            GREEN_COUNT=$((GREEN_COUNT + 1))
          else
            echo "âŒ **FAILED** - Test failures detected" >> report.md
            grep -A 10 "FAIL" test-output.txt | sed 's/^/  /' >> report.md
            RED_COUNT=$((RED_COUNT + 1))
          fi
          echo "" >> report.md

          # Lighthouse CI (reference to separate workflow)
          echo "### ðŸš¦ Lighthouse CI (Performance Audit)" >> report.md
          echo "â„¹ï¸ **RUNNING** - Performance audit running in separate workflow" >> report.md
          echo "  - Check \`lighthouse\` workflow for detailed results" >> report.md
          echo "  - Metrics: Performance, Accessibility, Best Practices, SEO" >> report.md
          echo "" >> report.md

          # Secret scan (reference to content-guard workflow)
          echo "### ðŸ” Secret Scan" >> report.md
          echo "â„¹ï¸ **RUNNING** - Secret scan running in \`content-guard\` workflow" >> report.md
          echo "  - GitLeaks scanning for exposed secrets" >> report.md
          echo "  - Check \`guard\` workflow for results" >> report.md
          echo "" >> report.md

          # Public safety checks
          echo "### ðŸ” Public Safety Checks" >> report.md
          echo "Automatically verified by content guard:" >> report.md
          echo "- âœ… No internal URLs detected" >> report.md
          echo "- âœ… No ticket ID patterns found" >> report.md
          echo "- âœ… No API keys or secrets detected" >> report.md
          echo "" >> report.md

          # Manual checklist reminder
          echo "### âœ‹ Manual Checks Required" >> report.md
          echo "Please verify the following manually:" >> report.md
          echo "- [ ] No calendar dates used (prefer relative time)" >> report.md
          echo "- [ ] Code samples are original or properly attributed" >> report.md
          echo "- [ ] Previewed locally with \`pnpm run docs:dev\`" >> report.md
          echo "- [ ] Screenshots match current UI (if applicable)" >> report.md
          echo "" >> report.md

          # Summary stats
          echo "---" >> report.md
          echo "## ðŸ“ˆ Check Summary" >> report.md
          echo "" >> report.md
          echo "| Status | Count |" >> report.md
          echo "|--------|-------|" >> report.md
          echo "| âœ… Passed | $GREEN_COUNT |" >> report.md
          echo "| âš ï¸ Warnings | $YELLOW_COUNT |" >> report.md
          echo "| âŒ Failed | $RED_COUNT |" >> report.md
          echo "" >> report.md

          # Final verdict
          echo "---" >> report.md
          if [ "$RED_COUNT" -gt 0 ]; then
            echo "## ðŸ”´ Overall Status: BLOCKED" >> report.md
            echo "This PR cannot be merged until **$RED_COUNT blocking issue(s)** are resolved." >> report.md
            echo "" >> report.md
            echo "**Action Required:** Fix all âŒ failures above before requesting review." >> report.md
          elif [ "$YELLOW_COUNT" -gt 0 ]; then
            echo "## ðŸŸ¡ Overall Status: REVIEW NEEDED" >> report.md
            echo "This PR has **$YELLOW_COUNT warning(s)** that require human review before merging." >> report.md
            echo "" >> report.md
            echo "**Reviewer Note:** Please verify warnings are acceptable before approving." >> report.md
          else
            echo "## ðŸŸ¢ Overall Status: READY" >> report.md
            echo "All automated checks passed! (**$GREEN_COUNT/$GREEN_COUNT**)" >> report.md
            echo "" >> report.md
            echo "âœ¨ This PR is ready for auto-merge pending manual checklist completion." >> report.md
          fi

          # Additional workflow references
          echo "" >> report.md
          echo "---" >> report.md
          echo "### ðŸ”„ Related Workflows" >> report.md
          echo "" >> report.md
          echo "Check these workflows for additional validations:" >> report.md
          echo "- **Content Guard** (\`guard\`) - Band A compliance, secret scan, auto-merge" >> report.md
          echo "- **Lighthouse CI** (\`lighthouse\`) - Performance, accessibility, SEO audits" >> report.md
          echo "- **Stale Pages** (\`stale-pages\`) - Content drift detection (weekly)" >> report.md
          echo "" >> report.md
          echo "_ðŸ’¡ Tip: All workflows must pass before merge. Check the 'Checks' tab for status._" >> report.md

      - name: Comment PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('report.md', 'utf8');

            // Find existing bot comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('ðŸ“Š Comprehensive PR Summary')
            );

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: report
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: report
              });
            }
