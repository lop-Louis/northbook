name: Lighthouse CI

on:
  pull_request:
    branches: [main]
    paths: ['docs/**', '.vitepress/**']
  push:
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  lighthouse:
    name: Performance Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v5

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Determine Playwright version
        id: playwright-version
        run: |
          PLAYWRIGHT_VERSION=$(node -p "require('playwright/package.json').version")
          echo "version=${PLAYWRIGHT_VERSION}" >> "$GITHUB_OUTPUT"

      - name: Configure Playwright cache path
        id: playwright-path
        run: |
          PLAYWRIGHT_CACHE="$HOME/.cache/ms-playwright"
          mkdir -p "$PLAYWRIGHT_CACHE"
          echo "PLAYWRIGHT_BROWSERS_PATH=$PLAYWRIGHT_CACHE" >> "$GITHUB_ENV"
          echo "path=$PLAYWRIGHT_CACHE" >> "$GITHUB_OUTPUT"

      - name: Restore Playwright browsers
        id: playwright-cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ steps.playwright-path.outputs.path }}
          key: playwright-browsers-${{ runner.os }}-${{ runner.arch }}-${{ steps.playwright-version.outputs.version }}
          restore-keys: |
            playwright-browsers-${{ runner.os }}-${{ runner.arch }}-
            playwright-browsers-${{ runner.os }}-

      - name: Install Playwright browsers
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        run: npx playwright install chromium --with-deps

      - name: Save Playwright browsers cache
        if: steps.playwright-cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ steps.playwright-path.outputs.path }}
          key: playwright-browsers-${{ runner.os }}-${{ runner.arch }}-${{ steps.playwright-version.outputs.version }}

      - name: Build site
        env:
          VITE_GA_ID: ${{ secrets.GA_ID || 'G-511628512' }}
        run: pnpm run docs:build

      - name: Run Lighthouse CI with Playwright
        id: lighthouse
        run: pnpm run lighthouse
        continue-on-error: true

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouse/
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read latest results
            const lighthouseDir = '.lighthouse';
            const files = fs.readdirSync(lighthouseDir);
            const latestFile = files.sort().reverse()[0];
            const results = JSON.parse(fs.readFileSync(path.join(lighthouseDir, latestFile), 'utf8'));

            // Build comment
            let comment = `## üî¶ Lighthouse Performance Report\n\n`;
            comment += `Performance audit completed with Playwright-managed server.\n\n`;

            const thresholds = {
              performance: 90,
              accessibility: 100,
              bestPractices: 90,
              seo: 90
            };

            for (const result of results) {
              if (result.error) {
                comment += `### ‚ùå ${result.url}\n\n`;
                comment += `Error: ${result.error}\n\n`;
                continue;
              }

              comment += `### üîó ${result.url}\n\n`;
              comment += `| Category | Score | Threshold | Status |\n`;
              comment += `|----------|-------|-----------|--------|\n`;

              for (const [category, score] of Object.entries(result.scores)) {
                const threshold = thresholds[category];
                const passed = score >= threshold;
                const icon = passed ? '‚úÖ' : '‚ùå';
                const displayName = category.charAt(0).toUpperCase() + category.slice(1).replace(/([A-Z])/g, ' $1');

                comment += `| ${displayName} | **${score}** | ${threshold} | ${icon} |\n`;
              }
              comment += `\n`;
            }

            comment += `\nüìä **Performance Targets:**\n`;
            comment += `- Performance: ‚â•90 (production-ready)\n`;
            comment += `- Accessibility: 100 (WCAG AA compliance)\n`;
            comment += `- Best Practices: ‚â•90\n`;
            comment += `- SEO: ‚â•90\n\n`;
            comment += `_Powered by Lighthouse + Playwright for reliable CI execution_`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
