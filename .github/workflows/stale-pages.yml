name: Stale Page Audit

on:
  schedule:
    - cron: '0 2 * * 1' # Every Monday at 2 AM UTC
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  stale:
    name: Scan for Stale Pages
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0 # Need full history to check last commit dates

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run stale detection
        run: pnpm run stale > stale-report.md

      - name: Check if report has content
        id: check
        run: |
          if grep -q "No stale pages found" stale-report.md; then
            echo "has_stale=false" >> $GITHUB_OUTPUT
          else
            echo "has_stale=true" >> $GITHUB_OUTPUT
          fi

      - name: Find existing stale report issue
        id: find-issue
        if: steps.check.outputs.has_stale == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'stale,automated'
            });
            const existingIssue = issues.data.find(issue =>
              issue.title.includes('Stale Pages Report')
            );
            return existingIssue ? existingIssue.number : null;

      - name: Create or update stale report issue
        if: steps.check.outputs.has_stale == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('stale-report.md', 'utf8');
            const issueNumber = ${{ steps.find-issue.outputs.result }};

            const issueData = {
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ“… Stale Pages Report',
              body: report,
              labels: ['stale', 'automated', 'documentation']
            };

            if (issueNumber) {
              // Update existing issue
              await github.rest.issues.update({
                ...issueData,
                issue_number: issueNumber
              });
              console.log(`Updated issue #${issueNumber}`);
            } else {
              // Create new issue
              const issue = await github.rest.issues.create(issueData);
              console.log(`Created issue #${issue.data.number}`);
            }

      - name: Update page status
        if: steps.check.outputs.has_stale == 'true'
        run: |
          echo "ðŸ”„ Updating stale page frontmatter..."
          node -e "
          const fs = require('fs');
          const path = require('path');
          const matter = require('gray-matter');

          function updateStalePages(dir = 'docs') {
            for (const f of fs.readdirSync(dir)) {
              const p = path.join(dir, f);
              const s = fs.statSync(p);
              if (s.isDirectory() && f !== 'node_modules' && !f.startsWith('.')) {
                updateStalePages(p);
              } else if (p.endsWith('.md') && !p.includes('.vitepress')) {
                const raw = fs.readFileSync(p, 'utf8');
                const { data, content } = matter(raw);

                // Check if page is stale and status is still 'live'
                const refresh = Number(data.refresh_after_days ?? 90);
                const mtime = s.mtime;
                const age = Math.floor((Date.now() - mtime.getTime()) / 86400000);

                if (age > refresh && data.status === 'live') {
                  data.status = 'stale';
                  const updated = matter.stringify(content, data);
                  fs.writeFileSync(p, updated);
                  console.log(\`Updated \${p} to status: stale\`);
                }
              }
            }
          }

          updateStalePages();
          "

      - name: Create PR for stale status updates
        if: steps.check.outputs.has_stale == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: 'chore: mark stale pages'
          title: 'ðŸ¤– Mark stale pages for review'
          body: |
            Automated update from weekly stale page audit.

            Pages that exceeded their `refresh_after_days` threshold have been marked as `status: stale`.

            Please review the linked issue for the full report.
          branch: bot/stale-updates
          labels: stale, automated
          delete-branch: true

      - name: Close issue if no stale pages
        if: steps.check.outputs.has_stale == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'stale,automated'
            });

            for (const issue of issues.data) {
              if (issue.title.includes('Stale Pages Report')) {
                await github.rest.issues.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issue.number,
                  state: 'closed',
                  body: issue.body + '\n\n---\nâœ… All pages are now up to date. Closing this issue.'
                });
                console.log(`Closed issue #${issue.number} - no stale pages remaining`);
              }
            }
