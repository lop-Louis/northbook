name: Unified Quality Gate

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths: ['docs/**', 'runbooks/**', 'scripts/**', '.github/**', '**.vue', '**.ts']

permissions:
  contents: read
  pull-requests: read

jobs:
  quality_gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false

    env:
      DIST_DIR: ${{ github.workspace }}/docs/.vitepress/dist
      BASE_URL: /

    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ---------------------
      # ðŸ”´ BLOCKERS (must pass)
      # ---------------------

      - name: ðŸ”´ Markdown lint & links
        id: markdown_lint
        run: pnpm run lint:md

      - name: ðŸ”´ Frontmatter schema
        id: frontmatter
        run: pnpm run frontmatter:lint

      - name: ðŸ”´ Release folder structure
        id: release_folders
        run: pnpm run release:folders:check

      # New: build must succeed â†’ L4 if not
      - name: ðŸ”´ Build VitePress site
        id: build_docs
        run: pnpm run docs:build
        # typical script: "docs:build": "vitepress build docs"

      # New: crawl built site for broken links â†’ L4 if internal links fail
      - name: ðŸ”´ Check internal links (dist crawl)
        id: link_check_internal
        uses: lycheeverse/lychee-action@v2.7.0
        with:
          args: >-
            --offline
            --root-dir "${{ env.DIST_DIR }}"
            --require-https
            --exclude-path '(^|/)drafts/.*'
            --github-token "${{ secrets.GITHUB_TOKEN }}"
            "${{ env.DIST_DIR }}/**/*.html"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------
      # ðŸŸ¡ WARNERS (non-blocking)
      # ---------------------

      - name: ðŸŸ¡ Content guard (L2/L3 logs)
        id: content_guard
        run: pnpm run guard
        continue-on-error: true

      - name: ðŸŸ¡ UX scan
        id: ux_scan
        run: pnpm run ux:scan
        continue-on-error: true

      - name: ðŸŸ¡ Drift detection
        id: drift
        run: pnpm run drift
        continue-on-error: true

      - name: ðŸŸ¡ Stale pages
        id: stale
        run: pnpm run stale
        continue-on-error: true

      - name: ðŸŸ¡ Accessibility
        id: accessibility
        run: pnpm run test:components
        continue-on-error: true

      - name: ðŸŸ¡ Unit tests
        id: unit_tests
        run: pnpm run test:unit
        continue-on-error: true

      # Optional: external link check as advisory (keeps flakes out)
      - name: ðŸŸ¡ Check external links (advisory)
        id: link_check_external
        uses: lycheeverse/lychee-action@v2.7.0
        with:
          args: >-
            --no-progress
            --max-concurrency 8
            --github-token "${{ secrets.GITHUB_TOKEN }}"
            --retry-wait-secs 5
            --max-retries 4
            --accept 200,403,429
            --exclude "https://localhost/*"
            --exclude "https://github.com/lop-louis/northbook/issues/new.*"
            --exclude "https://github.com/lop-louis/northbook/edit/.*"
            "${{ env.DIST_DIR }}/**/*.html"
        continue-on-error: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------
      # ðŸ“¦ Preview artifact (optional but handy)
      # ---------------------
      - name: Upload preview artifact
        if: always() && steps.build_docs.outcome == 'success'
        uses: actions/upload-artifact@v5
        with:
          name: preview-dist
          path: ${{ env.DIST_DIR }}
          retention-days: 7

      # ---------------------
      # ðŸ§¾ SUMMARY REPORT
      # ---------------------
      - name: Generate summary
        if: always()
        run: |
          echo "# Quality Gate Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## ðŸ”´ Critical (Must Pass)" >> $GITHUB_STEP_SUMMARY
          echo "âœ… markdown lint" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.markdown_lint.outcome }}" != "success" ] && echo "âŒ **markdown lint failed**" >> $GITHUB_STEP_SUMMARY || echo "âœ… markdown lint" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.frontmatter.outcome }}" != "success" ] && echo "âŒ **frontmatter failed**" >> $GITHUB_STEP_SUMMARY || echo "âœ… frontmatter" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.release_folders.outcome }}" != "success" ] && echo "âŒ **release folders failed**" >> $GITHUB_STEP_SUMMARY || echo "âœ… release folders" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.build_docs.outcome }}" != "success" ] && echo "âŒ **build docs failed**" >> $GITHUB_STEP_SUMMARY || echo "âœ… build docs" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.link_check_internal.outcome }}" != "success" ] && echo "âŒ **link check internal failed**" >> $GITHUB_STEP_SUMMARY || echo "âœ… link check internal" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸŸ¡ Advisory (Non-Blocking)" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.content_guard.outcome }}" = "success" ] && echo "âœ… content guard" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ content guard â€“ review warnings" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.ux_scan.outcome }}" = "success" ] && echo "âœ… ux scan" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ ux scan â€“ review warnings" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.drift.outcome }}" = "success" ] && echo "âœ… drift" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ drift â€“ review warnings" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.stale.outcome }}" = "success" ] && echo "âœ… stale" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ stale â€“ review warnings" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.accessibility.outcome }}" = "success" ] && echo "âœ… accessibility" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ accessibility â€“ review warnings" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.unit_tests.outcome }}" = "success" ] && echo "âœ… unit tests" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ unit tests â€“ review warnings" >> $GITHUB_STEP_SUMMARY
          [ "${{ steps.link_check_external.outcome }}" = "success" ] && echo "âœ… link check external" >> $GITHUB_STEP_SUMMARY || echo "âš ï¸ link check external â€“ review warnings" >> $GITHUB_STEP_SUMMARY

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.markdown_lint.outcome }}" = "success" ] \
             && [ "${{ steps.frontmatter.outcome }}" = "success" ] \
             && [ "${{ steps.release_folders.outcome }}" = "success" ] \
             && [ "${{ steps.build_docs.outcome }}" = "success" ] \
             && [ "${{ steps.link_check_internal.outcome }}" = "success" ]; then
            echo "âœ¨ **All critical checks passed** â€“ ready to merge" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš« **Critical checks failed** â€“ fix blockers above before merging" >> $GITHUB_STEP_SUMMARY
          fi
