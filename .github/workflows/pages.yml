name: Deploy versioned docs to Pages

on:
  push:
    branches:
      - main
      - development
    paths:
      - 'docs/**'
      - 'runbooks/**'
      - '.github/workflows/pages.yml'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'scripts/**'
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: 'pages'
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GA_ID: ${{ secrets.GA_ID || 'G-511628512' }}
    steps:
      - name: Checkout root (tooling)
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Checkout main (release)
        uses: actions/checkout@v5
        with:
          ref: main
          path: release
          fetch-depth: 0

      - name: Checkout development (staging)
        uses: actions/checkout@v5
        with:
          ref: development
          path: staging
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'pnpm'
          cache-dependency-path: |
            release/pnpm-lock.yaml
            staging/pnpm-lock.yaml

      - name: Install dependencies (release)
        run: pnpm install --frozen-lockfile
        working-directory: release

      - name: Build main â†’ /v1
        working-directory: release
        env:
          SITE_BASE: /v1/
          EDIT_BRANCH: main
          VITE_GA_ID: ${{ env.GA_ID }}
        run: pnpm run docs:build

      - name: Install dependencies (staging)
        run: pnpm install --frozen-lockfile
        working-directory: staging

      - name: Build development â†’ /staging
        working-directory: staging
        env:
          SITE_BASE: /staging/
          EDIT_BRANCH: development
          VITE_GA_ID: ${{ env.GA_ID }}
          SKIP_ANALYTICS: 'true'
        run: pnpm run docs:build

      - name: Capture commit metadata
        id: metadata
        run: |
          echo "release_sha=$(git -C release rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "staging_sha=$(git -C staging rev-parse HEAD)" >> "$GITHUB_OUTPUT"
          echo "generated_at=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"

      - name: Assemble deployment payload
        run: |
          rm -rf public
          mkdir -p public/v1 public/staging
          rsync -a --delete release/docs/.vitepress/dist/ public/v1/
          rsync -a --delete staging/docs/.vitepress/dist/ public/staging/

      - name: Create redirect + versions manifest
        env:
          RELEASE_SHA: ${{ steps.metadata.outputs.release_sha }}
          STAGING_SHA: ${{ steps.metadata.outputs.staging_sha }}
          GENERATED_AT: ${{ steps.metadata.outputs.generated_at }}
          OUTPUT_DIR: ../public
          LATEST_VERSION: v1
          RELEASE_BRANCH: main
          STAGING_BRANCH: development
          REDIRECT_TARGET: /v1/
        working-directory: release
        run: node scripts/generate-pages-assets.mjs

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4
        with:
          path: public

  deploy:
    needs: build
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: Smoke test production
        if: success()
        run: |
          echo "ğŸ§ª Running post-deploy smoke tests..."
          sleep 10

          curl -sf https://northbook.guide/v1/ | grep -q "Northbook" || {
            echo "âŒ /v1/ root failed"
            exit 1
          }
          echo "âœ… /v1/ responding"

          curl -sf https://northbook.guide/staging/ | grep -q "Northbook" || {
            echo "âŒ /staging/ root failed"
            exit 1
          }
          echo "âœ… /staging/ responding"

          curl -sf https://northbook.guide/v1/playbook/raci-by-seams | grep -q "RACI" || {
            echo "âŒ /v1/ RACI page failed"
            exit 1
          }
          echo "âœ… /v1/ RACI responding"

          curl -sf https://northbook.guide/v1/logo-lockup-light.png > /dev/null || {
            echo "âŒ v1 light logo missing"
            exit 1
          }
          echo "âœ… v1 light logo reachable"

          curl -sf https://northbook.guide/v1/logo-lockup-dark.png > /dev/null || {
            echo "âŒ v1 dark logo missing"
            exit 1
          }
          echo "âœ… v1 dark logo reachable"

          curl -sf https://northbook.guide/staging/playbook/raci-by-seams | grep -q "RACI" || {
            echo "âŒ /staging/ RACI page failed"
            exit 1
          }
          echo "âœ… /staging/ RACI responding"

          curl -sf https://northbook.guide/versions.json | grep -q "\"latest\"" || {
            echo "âŒ versions manifest missing"
            exit 1
          }
          echo "âœ… versions manifest reachable"

          echo "ğŸ‰ All smoke tests passed!"

      - name: Notify deployment
        if: success()
        run: |
          echo "ğŸš€ Site deployed to ${{ steps.deployment.outputs.page_url }}"
