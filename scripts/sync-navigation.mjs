#!/usr/bin/env node

import fs from 'node:fs'
import path from 'node:path'
import prettier from 'prettier'

const repoRoot = process.cwd()
const docsDir = path.join(repoRoot, 'docs')
const outputPath = path.join(docsDir, '.vitepress', 'navigation.generated.ts')
const FIXED_NAV = [{ text: 'Start here', link: '/start-here/' }]
const SIDEBAR_BLUEPRINT = [
  {
    text: 'Navigate',
    collapsed: false,
    items: [
      { text: 'Navigate overview', link: '/navigate/' },
      { text: 'Frontend charter', link: '/navigate/frontend-charter' }
    ]
  },
  {
    text: 'Operate',
    collapsed: false,
    items: [
      { text: 'Operate overview', link: '/operate/' },
      { text: 'Casual vs Operation defaults', link: '/operate/ops-defaults-meetings' },
      { text: 'Steward roster', link: '/operate/stewards' }
    ]
  },
  {
    text: 'Learn',
    collapsed: false,
    items: [
      { text: 'Learn overview', link: '/learn/' },
      { text: 'Signals roster', link: '/learn/signals-roster' }
    ]
  },
  {
    text: 'Mitigate',
    collapsed: false,
    items: [
      { text: 'Mitigate overview', link: '/mitigate/' },
      { text: 'Cloud access blocks', link: '/mitigate/exception-cloud-access' }
    ]
  }
]

function collectMarkdownFiles(dir) {
  const results = []

  function walk(current) {
    const entries = fs.readdirSync(current, { withFileTypes: true })
    for (const entry of entries) {
      if (entry.name.startsWith('.')) continue
      if (entry.name === 'node_modules') continue
      const fullPath = path.join(current, entry.name)
      if (entry.isDirectory()) {
        walk(fullPath)
      } else if (entry.isFile() && entry.name.endsWith('.md')) {
        results.push(fullPath)
      }
    }
  }

  walk(dir)
  return results
}

function routeFromFile(filePath) {
  const relative = path.relative(docsDir, filePath).replace(/\\/g, '/')
  if (relative === 'index.md') return '/'
  if (relative.endsWith('/index.md')) {
    return `/${relative.slice(0, -'index.md'.length)}`
  }
  return `/${relative.replace(/\.md$/, '')}`
}

function isDraftPath(filePath) {
  const relative = path.relative(docsDir, filePath)
  return relative.split(path.sep).includes('drafts')
}

function normalizeRoute(link) {
  if (link === '/') return '/'
  return link
}

function buildNavigation() {
  const files = collectMarkdownFiles(docsDir)
  const publishableRoutes = new Set()

  for (const file of files) {
    if (file.includes(`${path.sep}.vitepress${path.sep}`)) continue
    if (isDraftPath(file)) continue

    const route = routeFromFile(file)

    publishableRoutes.add(route)
  }

  const nav = FIXED_NAV.map(item => {
    const normalized = normalizeRoute(item.link)
    if (!publishableRoutes.has(normalized)) {
      throw new Error(`Nav entry ${normalized} is missing or not publishable`)
    }
    return item
  })

  const missingSidebar = new Set()
  const sidebar = []

  for (const group of SIDEBAR_BLUEPRINT) {
    if (group.items) {
      const items = group.items.filter(item => {
        const normalized = normalizeRoute(item.link)
        if (publishableRoutes.has(normalized)) {
          return true
        }
        missingSidebar.add(normalized)
        return false
      })
      if (items.length) {
        sidebar.push({ text: group.text, collapsed: group.collapsed, items })
      }
    } else if (group.link && group.text) {
      const normalized = normalizeRoute(group.link)
      if (publishableRoutes.has(normalized)) {
        sidebar.push({ text: group.text, link: group.link })
      } else {
        missingSidebar.add(normalized)
      }
    }
  }

  if (missingSidebar.size) {
    console.warn(
      'Sidebar items skipped (await opener/frontmatter fixes):',
      Array.from(missingSidebar).join(', ')
    )
  }

  return { nav, sidebar }
}

async function writeNavigation(nav, sidebar) {
  const banner = `import { DefaultTheme } from 'vitepress';\n\n// Auto-generated by scripts/sync-navigation.mjs\n// Do not edit manually.\n`
  const content = `${banner}export const generatedNav = ${JSON.stringify(
    nav,
    null,
    2
  )} as DefaultTheme.NavItem[];\n\nexport const generatedSidebar = ${JSON.stringify(
    sidebar,
    null,
    2
  )} as DefaultTheme.Sidebar;\n`
  const formatted = await prettier.format(content, {
    parser: 'typescript',
    singleQuote: true,
    semi: false,
    trailingComma: 'none'
  })
  fs.writeFileSync(outputPath, formatted)
  console.log(`Navigation synced -> ${path.relative(repoRoot, outputPath)}`)
}

const { nav, sidebar } = buildNavigation()
await writeNavigation(nav, sidebar)
