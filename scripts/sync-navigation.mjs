#!/usr/bin/env node

import fs from 'node:fs'
import path from 'node:path'
import matter from 'gray-matter'
import prettier from 'prettier'

const repoRoot = process.cwd()
const docsDir = path.join(repoRoot, 'docs')
const outputPath = path.join(docsDir, '.vitepress', 'navigation.generated.ts')
const GROUP_ORDER = new Map([
  ['Start here', 10],
  ['Guides', 20],
  ['Runbooks', 30],
  ['Contributor Kit', 40]
])

function collectMarkdownFiles(dir) {
  const results = []

  function walk(current) {
    const entries = fs.readdirSync(current, { withFileTypes: true })

    for (const entry of entries) {
      if (entry.name.startsWith('.')) continue
      if (entry.name === 'node_modules') continue
      if (entry.isDirectory()) {
        walk(path.join(current, entry.name))
      } else if (entry.isFile() && entry.name.endsWith('.md')) {
        results.push(path.join(current, entry.name))
      }
    }
  }

  walk(dir)
  return results
}

function routeFromFile(filePath) {
  const relative = path.relative(docsDir, filePath).replace(/\\/g, '/')
  if (relative === 'index.md') return '/'
  if (relative.endsWith('/index.md')) {
    return `/${relative.slice(0, -'index.md'.length)}`
  }
  return `/${relative.replace(/\.md$/, '')}`
}

function normalizeNavEntry(entry) {
  if (!entry) return null
  if (typeof entry === 'string') {
    return { slot: entry }
  }
  if (typeof entry === 'object') {
    const { slot, label, group, order } = entry
    return { slot, label, group, order }
  }
  return null
}

function deriveGroup(route) {
  const clean = route.replace(/^\/+/, '')
  const [segment] = clean.split('/')
  switch (segment) {
    case '':
      return 'Start here'
    case 'start-here':
      return 'Start here'
    case 'playbook':
      return 'Guides'
    case 'runbooks':
      return 'Runbooks'
    default:
      return 'Guides'
  }
}

function formatItems(items) {
  return items
    .sort((a, b) => a.order - b.order || a.text.localeCompare(b.text))
    .map(({ text, link }) => ({ text, link }))
}

function buildNavigation() {
  const files = collectMarkdownFiles(docsDir)
  const mainNav = []
  const sidebarGroups = new Map()

  for (const file of files) {
    const raw = fs.readFileSync(file, 'utf8')
    const { data } = matter(raw)

    if (!data || !data.nav) continue

    const entries = Array.isArray(data.nav) ? data.nav : [data.nav]
    const route = routeFromFile(file)
    const defaultLabel = data.nav_label || data.short_title || data.title
    const defaultGroup = data.nav_group
    const defaultOrder =
      typeof data.nav_order === 'number' && Number.isFinite(data.nav_order) ? data.nav_order : 1000

    for (const rawEntry of entries) {
      const entry = normalizeNavEntry(rawEntry)
      if (!entry || entry.slot === 'none') continue

      const label = entry.label || defaultLabel
      if (!label) continue
      const order =
        typeof entry.order === 'number' && Number.isFinite(entry.order) ? entry.order : defaultOrder

      if (entry.slot === 'main') {
        mainNav.push({ text: label, link: route, order })
      } else if (entry.slot === 'sidebar') {
        const group = entry.group || defaultGroup || deriveGroup(route)
        const key = group || 'Guides'
        const existing = sidebarGroups.get(key) || {
          text: key,
          order,
          items: []
        }
        const preferredGroupOrder = GROUP_ORDER.get(key)
        if (typeof preferredGroupOrder === 'number') {
          existing.order = preferredGroupOrder
        } else {
          existing.order = Math.min(existing.order, order)
        }
        existing.items.push({ text: label, link: route, order })
        sidebarGroups.set(key, existing)
      }
    }
  }

  const nav = formatItems(mainNav)
  const sidebar = Array.from(sidebarGroups.values())
    .sort((a, b) => a.order - b.order || a.text.localeCompare(b.text))
    .map(group => ({
      text: group.text,
      collapsed: false,
      items: formatItems(group.items)
    }))

  return { nav, sidebar }
}

async function writeNavigation(nav, sidebar) {
  const banner = `// Auto-generated by scripts/sync-navigation.mjs\n// Do not edit manually.\n`
  const content = `${banner}export const generatedNav = ${JSON.stringify(
    nav,
    null,
    2
  )} as const;\nexport const generatedSidebar = ${JSON.stringify(sidebar, null, 2)} as const;\n`
  const formatted = await prettier.format(content, {
    parser: 'typescript',
    singleQuote: true,
    semi: false,
    trailingComma: 'none'
  })
  fs.writeFileSync(outputPath, formatted)
  console.log(`Navigation synced -> ${path.relative(repoRoot, outputPath)}`)
}

const { nav, sidebar } = buildNavigation()
await writeNavigation(nav, sidebar)
